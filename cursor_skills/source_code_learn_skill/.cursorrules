# Cursor Rules - 源码阅读与文档生成规范（增强版）

## 一、核心原则

### 1. 讲解顺序：原理先行
- 第0层：基础概念和原理（无代码）
- 第1层：核心机制原理（概念性代码）
- 第2层：源码实现（真实代码 + 行号）
- 第3层：实战应用和面试题

**禁止**：直接展示大段源码而不先讲解原理

### 2. 图示优先
必须使用图示的场景：
- 流程图：展示执行流程
- 时序图：展示时间维度的交互
- 架构图：展示模块关系
- 数据流图：展示数据传递
- 对比图：展示优化前后的差异
- 状态机图：展示状态转换

### 3. 深入浅出
三层讲解法：
- 类比层：用生活中的例子类比
- 概念层：用伪代码或概念性代码说明
- 实现层：展示真实源码

---

## 二、文档结构规范

### 1. 章节标题格式
```markdown
# 项目名称 - 第X章：章节主题

## 本章目标
- 目标1
- 目标2
- 目标3

**重要提示**：本章会先回顾原理，然后引导看相关源码。
```

### 2. 原理讲解模板
```markdown
## X.X 概念名称

### X.X.1 为什么需要这个概念？

**问题场景**：
- 描述遇到的问题
- 说明朴素方案的不足

**解决方案**：
- 提出解决方案
- 说明核心思想

### X.X.2 概念的核心原理

**类比**：
[用生活中的例子类比]

**原理图**：
[ASCII 图示]

**关键点**：
1. 关键点 1
2. 关键点 2
3. 关键点 3

### X.X.3 概念性代码

\`\`\`python
# 概念性代码，帮助理解
def concept_example():
    # 步骤 1
    step1()
    # 步骤 2
    step2()
\`\`\`

**说明**：
- 这是概念性代码，不是真实实现
- 目的是帮助理解核心逻辑
```

### 3. 源码讲解模板
```markdown
## X.X 源码实现

### X.X.1 引导

**引导**：理解了XXX的原理后，我们来看 PyTorch 如何实现。重点关注：
1. 关注点1
2. 关注点2
3. 关注点3

### X.X.2 代码位置

**代码位置**：\`path/to/file.py:startLine-endLine\`

### X.X.3 源码展示

\`\`\`startLine:endLine:path/to/file.py
# 真实源码
def real_implementation():
    pass
\`\`\`

### X.X.4 源码解析

#### 1. 功能模块1

**代码**：
\`\`\`python
# 关键代码片段
\`\`\`

**作用**：
- 作用1
- 作用2

**为什么这样做**：
- 原因1
- 原因2

#### 2. 功能模块2

...

### X.X.5 执行流程图

[流程图]

### X.X.6 关键点总结

1. 关键点 1
2. 关键点 2
3. 关键点 3
```

### 4. 章节结尾模板
```markdown
## X.N 本章总结

### 核心流程总结

[流程图或架构图]

### 关键设计点

1. 设计点1
2. 设计点2
3. 设计点3

---

## X.N+1 面试题

### 基础题

**Q1：问题描述？**

**答案**：
- 答案要点1
- 答案要点2

### 进阶题

**Q2：问题描述？**

**答案**：
- 详细解答
- 包含原理和实现

### 深入题

**Q3：问题描述？**

**答案**：
- 深入分析
- 包含代码示例

---

**学习建议**：
1. 建议1
2. 建议2
3. 准备好后，进入下一章学习XXX
```

---

## 三、图示规范

### 1. 流程图

**ASCII 版本**（简单流程）：
```
┌─────────────────┐
│  开始           │
└────────┬────────┘
         ↓
┌─────────────────┐
│  步骤 1         │
└────────┬────────┘
         ↓
    ┌────┴────┐
    │ 判断？  │
    └─┬────┬──┘
  是 ↓    ↓ 否
┌─────┐ ┌─────┐
│步骤2│ │步骤3│
└──┬──┘ └──┬──┘
   └───┬───┘
       ↓
   ┌───────┐
   │ 结束  │
   └───────┘
```

**Mermaid 版本**（复杂流程，推荐）：
```mermaid
flowchart TD
    A[开始] --> B[步骤1]
    B --> C{判断？}
    C -->|是| D[步骤2]
    C -->|否| E[步骤3]
    D --> F[结束]
    E --> F

    style C fill:#ffd43b
    style F fill:#51cf66
```

### 2. 时序图

**ASCII 版本**（简单时间线）：
```
时间 →
─────────────────────────────────────
进程0 │ ████████░░░░░░░░████████
进程1 │ ░░░░░░░░████████░░░░░░░░
      │
      └─ ████ 计算  ░░░░ 通信
```

**Mermaid Sequence Diagram**（复杂交互，推荐）：
```mermaid
sequenceDiagram
    participant A as 组件A
    participant B as 组件B
    participant C as 组件C

    A->>B: 请求
    activate B
    B->>C: 转发
    C-->>B: 响应
    B-->>A: 返回结果
    deactivate B
```

**Mermaid Gantt Chart**（性能对比）：
```mermaid
gantt
    title 性能对比
    dateFormat X
    axisFormat %L

    section 方案A
    计算    :active, 0, 100
    通信    :crit, 100, 150

    section 方案B
    计算    :active, 0, 100
    通信    :50, 130
```

### 3. 架构图
```
┌─────────────────────────────────────┐
│          上层模块                   │
└──────────────┬──────────────────────┘
               ↓
    ┌──────────┴──────────┐
    ↓                     ↓
┌─────────┐          ┌─────────┐
│ 模块 A  │←────────→│ 模块 B  │
└────┬────┘          └────┬────┘
     ↓                    ↓
┌─────────┐          ┌─────────┐
│ 子模块  │          │ 子模块  │
└─────────┘          └─────────┘
```

### 4. 符号规范

**ASCII 符号**：
```
┌─┐ └─┘  方框（模块、步骤）
│ ─ ↓ ↑  连接线、箭头
████     实心块（计算）
░░░░     空心块（通信）
═══      分隔线
```

### 5. ASCII vs Mermaid 选择指南

| 场景 | ASCII | Mermaid | 推荐 |
|-----|-------|---------|-----|
| 简单流程（<5步） | ✅ | ✅ | **ASCII**（更快） |
| 复杂流程（>5步） | ⚠️ | ✅ | **Mermaid** |
| 状态机 | ⚠️ | ✅ | **Mermaid** |
| 时序图（多交互） | ❌ | ✅ | **Mermaid** |
| 类图/架构图 | ⚠️ | ✅ | **Mermaid** |
| 性能对比 | ⚠️ | ✅ | **Mermaid Gantt** |
| 纯文本环境 | ✅ | ❌ | **ASCII** |

**使用原则**：
1. 初稿使用 ASCII（快速草图）
2. 复杂图表使用 Mermaid（清晰美观）
3. 重要章节使用 Mermaid（高质量输出）
4. 发布时可选择性转换为图片（兼容性）

**Mermaid 工具链**：
- `mermaid_to_html.py`: 提取并生成 HTML
- `mermaid_to_image.py`: 转换为图片
- `replace_mermaid_with_images.py`: 自动替换

详见：`MERMAID_VISUALIZATION_GUIDE.md`

---

## 四、代码引用规范

### 1. 引用现有代码（使用行号）
```markdown
\`\`\`startLine:endLine:path/to/file.py
# 真实源码
def real_function():
    pass
\`\`\`
```

**要求**：
- 必须包含准确的行号
- 必须包含完整的文件路径
- 不要添加语言标签（如 `python`）

### 2. 概念性代码（不使用行号）
```markdown
\`\`\`python
# 概念性代码，帮助理解
def concept_function():
    pass
\`\`\`
```

**要求**：
- 必须添加语言标签
- 必须注明"概念性代码"
- 用于说明原理，不是真实实现

### 3. 示例代码（不使用行号）
```markdown
\`\`\`python
# 实战示例
import torch
model = torch.nn.Linear(10, 5)
\`\`\`
```

---

## 五、面试题规范

### 1. 题目分类
- **基础题**：概念理解、基本流程
- **进阶题**：原理深入、性能优化
- **深入题**：实现细节、边界情况

### 2. 答案格式
```markdown
**Q1：问题描述？**

**答案**：
- **核心观点**：一句话总结
- **详细解答**：
  1. 要点1
  2. 要点2
  3. 要点3
- **代码示例**（如果需要）：
  \`\`\`python
  # 示例代码
  \`\`\`
```

### 3. 题目数量
- 每章至少 8-12 道面试题
- 基础题：3-4 道
- 进阶题：3-4 道
- 深入题：3-4 道

---

## 六、写作风格

### 1. 语言要求
- 使用中文简体
- 专业术语使用英文（如 AllReduce、Bucket）
- 代码注释使用英文

### 2. 结构要求
- 重点内容前置
- 层次分明，使用标题层级
- 每个小节不超过 50 行

### 3. 禁止事项
- 禁止使用 emoji 表情符号
- 禁止使用特殊符号装饰
- 禁止直接展示超过 100 行的代码

---

## 七、质量检查清单

### 内容完整性
- [ ] 每个核心概念都有"为什么需要"
- [ ] 每个原理都有图示说明
- [ ] 每段源码都有行号标注
- [ ] 每个章节都有面试题

### 图示质量
- [ ] 核心知识点都有图示
- [ ] 图示清晰易懂
- [ ] 图示有图例说明
- [ ] 图示与文字对应

### 深入浅出
- [ ] 有生活类比
- [ ] 有概念性代码
- [ ] 有真实源码
- [ ] 有执行示例

### 结构清晰
- [ ] 章节层次分明
- [ ] 重点内容前置
- [ ] 代码位置明确
- [ ] 总结归纳到位

---

## 八、自动化脚本工具

本项目提供以下脚本工具（位于 `scripts/` 目录）：

### 1. 源码分析脚本
- `analyze_code.py`：分析源码结构、提取函数定义
- `find_dependencies.py`：查找函数调用关系
- `extract_docstrings.py`：提取文档字符串

### 2. 文档生成脚本
- `generate_toc.py`：自动生成目录
- `add_line_numbers.py`：为代码块添加行号
- `check_diagrams.py`：检查图示完整性

### 3. 质量检查脚本
- `check_format.py`：检查文档格式
- `validate_code_refs.py`：验证代码引用的行号
- `count_interview_questions.py`：统计面试题数量

使用方法：
```bash
# 分析源码
python scripts/analyze_code.py distributed.py

# 生成目录
python scripts/generate_toc.py DDP原理与源码解读-第1章.md

# 检查格式
python scripts/check_format.py DDP原理与源码解读-*.md
```

---

## 九、特殊场景处理

### 1. 处理 C++ 代码
- 说明代码位置（文件路径）
- 使用概念性 Python 代码说明逻辑
- 解释关键的 C++ 实现细节

### 2. 处理复杂流程
- 先展示宏观流程图
- 再逐个模块详细讲解
- 最后总结完整流程

### 3. 处理性能优化
- 先展示朴素方案
- 再展示优化方案
- 使用对比图展示差异
- 量化性能提升

---

## 十、文档维护

### 1. 文档命名
- 格式：`项目名称-第X章-章节主题.md`
- 示例：`DDP原理与源码解读-第1章-集合通信基础.md`

### 2. 文档更新
- 收集用户反馈
- 补充不清楚的概念
- 增加更多图示
- 优化代码示例

### 3. 版本控制
- 记录重大修改
- 保持向后兼容
- 标注更新日期
